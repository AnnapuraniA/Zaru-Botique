import express from 'express'
import upload from '../middleware/upload.js'
import multer from 'multer'
import { adminProtect } from '../middleware/adminAuth.js'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const router = express.Router()

// @route   POST /api/admin/upload/images
// @desc    Upload product images
// @access  Admin
router.post('/images', adminProtect, (req, res, next) => {
  upload.array('images', 10)(req, res, (err) => {
    if (err) {
      console.error('Multer error:', err)
      // Handle multer errors
      if (err instanceof multer.MulterError) {
        if (err.code === 'LIMIT_FILE_SIZE') {
          return res.status(400).json({ message: 'File size too large. Maximum size is 10MB.' })
        }
        if (err.code === 'LIMIT_FILE_COUNT') {
          return res.status(400).json({ message: 'Too many files. Maximum is 10 files.' })
        }
        return res.status(400).json({ message: err.message || 'File upload error' })
      }
      // Handle other errors (like fileFilter errors)
      return res.status(400).json({ message: err.message || 'File upload error' })
    }
    // No error, continue to handler
    next()
  })
}, async (req, res) => {
  try {
    console.log('Upload handler - req.files:', req.files)
    
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ message: 'No files uploaded' })
    }

      // Generate full URLs for uploaded files
      const protocol = req.protocol || 'http'
      const host = req.get('host') || 'localhost:5001'
      const baseUrl = `${protocol}://${host}`
      
      const imageUrls = req.files.map(file => {
        // Return full URL path that will be served statically
        return `${baseUrl}/uploads/products/${file.filename}`
      })

    console.log('Generated image URLs:', imageUrls)

    res.json({
      success: true,
      images: imageUrls,
      message: `${req.files.length} image(s) uploaded successfully`
    })
  } catch (error) {
    console.error('Image upload processing error:', error)
    res.status(500).json({ message: 'Failed to upload images', error: error.message })
  }
})

// @route   DELETE /api/admin/upload/images/:filename
// @desc    Delete uploaded image
// @access  Admin
router.delete('/images/:filename', adminProtect, async (req, res) => {
  try {
    const fs = await import('fs')
    const filePath = path.join(__dirname, '../uploads/products', req.params.filename)
    
    // Check if file exists
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath)
      res.json({ success: true, message: 'Image deleted successfully' })
    } else {
      res.status(404).json({ message: 'Image not found' })
    }
  } catch (error) {
    console.error('Image delete error:', error)
    res.status(500).json({ message: 'Failed to delete image' })
  }
})

export default router

